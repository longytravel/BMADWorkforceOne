# Story 2.8: Heatmap Performance Testing & Optimization

**Epic:** Epic 2 - CvD Heatmap & Coverage Intelligence
**Story Points:** 3
**Priority:** P1 - High

---

## Status

Ready

---

## Story

**As a** developer,
**I want** comprehensive performance testing and validation of the heatmap feature,
**so that** we ensure the application meets all performance NFRs before moving to Epic 3.

---

## Acceptance Criteria

1. **Given** the heatmap loads with demo data, **When** measuring initial render time, **Then** it should complete within 200ms (NFR2: interaction response time)
2. **Given** coverage data is recalculated, **When** triggered by an activity change, **Then** recalculation should complete within 500ms for 672 intervals (AC from Story 2.1)
3. **Given** the user hovers over cells, **When** moving rapidly across the heatmap, **Then** tooltips should appear/disappear smoothly without lag or flickering
4. **Given** the user clicks to open detail modal, **When** modal renders, **Then** it should open within 200ms (NFR2)
5. **Given** the heatmap is displayed, **When** measuring bundle size impact, **Then** heatmap-related code should not exceed 100KB (gzipped) to stay within overall bundle budget
6. **Given** performance tests run, **When** completed, **Then** all results should be documented with pass/fail status
7. **Given** performance issues are identified, **When** optimizations are needed, **Then** implement improvements and re-test to verify
8. **Given** the heatmap is tested, **When** validating memory usage, **Then** there should be no memory leaks after multiple render/update cycles

---

## Tasks / Subtasks

- [ ] Create performance test suite (AC: 1, 2, 3, 4)
  - [ ] Create src/components/CvDHeatmap/CvDHeatmap.perf.test.tsx
  - [ ] Test initial heatmap render time (< 200ms)
  - [ ] Test coverage recalculation time (< 500ms for 672 intervals)
  - [ ] Test tooltip interaction responsiveness
  - [ ] Test modal open time (< 200ms)
  - [ ] Use Vitest + React Testing Library + performance.now()

- [ ] Measure bundle size impact (AC: 5)
  - [ ] Run production build: `npm run build`
  - [ ] Analyze bundle using Vite build output
  - [ ] Check dist/assets/*.js file sizes (gzipped)
  - [ ] Verify heatmap-related chunks < 100KB
  - [ ] Optional: Use rollup-plugin-visualizer for detailed analysis

- [ ] Profile component rendering (AC: 1, 7)
  - [ ] Use React DevTools Profiler in browser
  - [ ] Measure CvDHeatmap component render time
  - [ ] Identify slow components or unnecessary re-renders
  - [ ] Verify React.memo on HeatmapCell is effective
  - [ ] Document findings

- [ ] Test memory usage and leak detection (AC: 8)
  - [ ] Use Chrome DevTools Memory Profiler
  - [ ] Take heap snapshot before heatmap load
  - [ ] Take heap snapshot after heatmap load
  - [ ] Trigger 10+ activity changes (add/delete/update)
  - [ ] Take final heap snapshot
  - [ ] Compare snapshots for retained objects
  - [ ] Verify no significant memory growth

- [ ] Stress test with large data (AC: 2, 7)
  - [ ] Test with maximum demo data: 100 agents, 672 intervals
  - [ ] Verify recalculation still < 500ms
  - [ ] Verify render still < 200ms
  - [ ] Document any degradation

- [ ] Test rapid interaction scenarios (AC: 3, 4)
  - [ ] Hover over 20+ cells rapidly (simulate mouse sweep)
  - [ ] Click 5+ cells in quick succession
  - [ ] Verify no UI freezing or stuttering
  - [ ] Use Chrome DevTools Performance tab to record

- [ ] Implement optimizations if needed (AC: 7)
  - [ ] If tests fail, identify bottlenecks
  - [ ] Possible optimizations:
    - [ ] Virtualize grid (react-window) if 672 cells is too many
    - [ ] Debounce tooltip updates
    - [ ] Lazy load modal component
    - [ ] Optimize coverage calculator algorithm
  - [ ] Re-run tests after optimizations

- [ ] Document performance results (AC: 6)
  - [ ] Create performance report in story's Completion Notes
  - [ ] Include benchmark numbers for each AC
  - [ ] Note any optimizations applied
  - [ ] Include screenshots from DevTools if relevant

- [ ] Run full test suite to ensure no regressions
  - [ ] `npm run test` (unit tests from Stories 2.1-2.7)
  - [ ] Verify all existing tests still pass
  - [ ] Fix any broken tests due to optimizations

---

## Dev Notes

### Architecture Context

This story **validates** that the heatmap feature meets all performance requirements defined in the PRD and architecture docs. It focuses on **testing, measurement, and optimization** rather than new feature development.

### Performance Requirements (Source: PRD requirements.md)

**NFR2:** The system shall respond to user interactions (clicks, hovers, drag-and-drop) within 200ms to ensure smooth, professional feel.

**NFR3:** The system shall calculate IOI scores for 50+ candidate time slots within 500ms.
- **Applied to heatmap:** Coverage recalculation for 672 intervals < 500ms

**NFR20 (FR20):** The system shall load demo data from JSON files within 2 seconds.

**Bundle Size Estimate (from Tech Stack):**
- Total target: ~380KB gzipped
- Heatmap portion should be < 100KB to leave room for Calendar, Smart Search, Audit features

[Source: docs/prd/requirements.md#Non-Functional Requirements]

### Testing Approach (Source: architecture/testing-strategy.md)

**Performance Testing Framework:**
```typescript
// src/components/CvDHeatmap/CvDHeatmap.perf.test.tsx
import { describe, it, expect } from 'vitest';
import { render } from '@testing-library/react';
import { CvDHeatmap } from './CvDHeatmap';
import { useStore } from '@/stores/appStore';

describe('Heatmap Performance Tests', () => {
  it('should render within 200ms', () => {
    // Setup: Load demo data into store
    const mockData = generateMockCvDData(672);
    useStore.setState({ cvdData: mockData });

    // Measure render time
    const start = performance.now();
    render(<CvDHeatmap />);
    const duration = performance.now() - start;

    expect(duration).toBeLessThan(200);
    console.log(`Heatmap rendered in ${duration.toFixed(2)}ms`);
  });

  it('should recalculate coverage within 500ms', () => {
    const { result } = renderHook(() => useStore());

    const start = performance.now();
    result.current.recalculateCvD();
    const duration = performance.now() - start;

    expect(duration).toBeLessThan(500);
    console.log(`Coverage recalculated in ${duration.toFixed(2)}ms`);
  });
});
```

[Source: architecture/testing-strategy.md#Test Examples]

### Profiling Tools

**React DevTools Profiler:**
1. Open app in Chrome
2. Open React DevTools → Profiler tab
3. Click "Record" button
4. Interact with heatmap (load, hover, click)
5. Stop recording
6. Analyze flame graph for slow components

**Chrome DevTools Performance Tab:**
1. Open Chrome DevTools → Performance tab
2. Click "Record" button
3. Interact with heatmap
4. Stop recording
5. Analyze main thread activity, FPS, memory usage

**Chrome DevTools Memory Profiler:**
1. Open Chrome DevTools → Memory tab
2. Select "Heap snapshot"
3. Take snapshot before loading heatmap
4. Load heatmap and interact
5. Take another snapshot
6. Compare snapshots for memory leaks

### Bundle Analysis

**Vite Build Output:**
```bash
npm run build
```

Output shows file sizes:
```
dist/assets/index-abc123.js    180.50 kB │ gzip: 65.20 kB
dist/assets/CvDHeatmap-xyz789.js  45.30 kB │ gzip: 18.50 kB
```

**Bundle Visualizer (Optional):**
```bash
npm install --save-dev rollup-plugin-visualizer
```

```typescript
// vite.config.ts
import { visualizer } from 'rollup-plugin-visualizer';

export default defineConfig({
  plugins: [
    react(),
    visualizer({ open: true, gzipSize: true })
  ]
});
```

### Common Performance Bottlenecks

**Issue 1: Too Many Re-renders**
- **Symptom:** Entire heatmap re-renders when one cell changes
- **Solution:** Verify React.memo on HeatmapCell
- **Verification:** React DevTools Profiler shows only affected cells re-render

**Issue 2: Slow Coverage Calculation**
- **Symptom:** recalculateCvD takes > 500ms
- **Solution:** Optimize algorithm (incremental updates instead of full recalc)
- **Verification:** Performance test passes

**Issue 3: Tooltip Flickering**
- **Symptom:** Tooltip flashes on/off when moving mouse
- **Solution:** Add CSS transition delay or debounce hover events
- **Verification:** Manual testing shows smooth tooltips

**Issue 4: Large Bundle Size**
- **Symptom:** Heatmap chunk > 100KB
- **Solution:** Code splitting, lazy loading, tree shaking unused libraries
- **Verification:** Build output shows reduced size

### Optimization Techniques

**Virtualization (if needed):**
```typescript
import { FixedSizeGrid } from 'react-window';

// Replace standard grid with virtualized grid
<FixedSizeGrid
  columnCount={7}
  rowCount={96}
  columnWidth={50}
  rowHeight={8}
  width={400}
  height={600}
>
  {({ columnIndex, rowIndex, style }) => (
    <div style={style}>
      <HeatmapCell dataPoint={getDataPoint(columnIndex, rowIndex)} />
    </div>
  )}
</FixedSizeGrid>
```

**Note:** Only implement if standard rendering exceeds 200ms.

**Lazy Loading Modal:**
```typescript
import { lazy, Suspense } from 'react';

const HeatmapDetailModal = lazy(() => import('./HeatmapDetailModal'));

// In component:
<Suspense fallback={<div>Loading...</div>}>
  {isOpen && <HeatmapDetailModal {...props} />}
</Suspense>
```

**Debounced Recalculation (if needed):**
```typescript
import { debounce } from 'lodash-es';

const debouncedRecalculate = debounce(() => {
  get().recalculateCvD();
}, 100);
```

**Memoized Grid Transformation:**
```typescript
const gridData = useMemo(() => {
  return transformCvDDataToGrid(cvdData);
}, [cvdData]);
```

### Performance Benchmarks

**Target Benchmarks (from NFRs):**
| Metric | Target | Story Source |
|--------|--------|--------------|
| Heatmap Initial Render | < 200ms | NFR2 |
| Coverage Recalculation | < 500ms | Story 2.1 AC8 |
| Tooltip Appearance | < 200ms | NFR2 |
| Modal Open | < 200ms | NFR2 |
| Bundle Size (heatmap) | < 100KB gzipped | Tech Stack |
| Memory Leak | None | NFR13 |

**Example Performance Report:**
```
=== Heatmap Performance Test Results ===

Initial Render: ✅ PASS (145ms / 200ms target)
Coverage Recalculation: ✅ PASS (320ms / 500ms target)
Tooltip Interaction: ✅ PASS (smooth, no lag)
Modal Open: ✅ PASS (110ms / 200ms target)
Bundle Size: ✅ PASS (82KB / 100KB target)
Memory Leak: ✅ PASS (no retained objects after 20 interactions)

Overall Status: ALL TESTS PASSED
Optimizations Applied: None needed
```

### Memory Leak Detection

**Common Causes:**
- Event listeners not cleaned up (useEffect cleanup)
- Timers not cleared (setTimeout, setInterval)
- Subscriptions not unsubscribed
- Large objects retained in closures

**Prevention:**
```typescript
useEffect(() => {
  const handleEvent = () => { /* ... */ };
  window.addEventListener('resize', handleEvent);

  return () => {
    window.removeEventListener('resize', handleEvent); // Cleanup
  };
}, []);
```

**Zustand Subscriptions:**
- Zustand handles cleanup automatically
- No manual unsubscribe needed

### Test Data Generation

**Generate Large Demo Data for Stress Testing:**
```typescript
function generateMockCvDData(intervalCount: number): CvDDataPoint[] {
  const data: CvDDataPoint[] = [];

  for (let i = 0; i < intervalCount; i++) {
    data.push({
      intervalStart: `2025-10-${Math.floor(i / 96) + 20}T${String(Math.floor((i % 96) / 4)).padStart(2, '0')}:${String((i % 4) * 15).padStart(2, '0')}:00Z`,
      dayOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][Math.floor(i / 96)],
      timeSlot: `${String(Math.floor((i % 96) / 4)).padStart(2, '0')}:${String((i % 4) * 15).padStart(2, '0')}`,
      forecastedCalls: Math.floor(Math.random() * 20) + 5,
      scheduledAgents: Math.floor(Math.random() * 15) + 3,
      coveragePercent: Math.floor(Math.random() * 60) + 70, // 70-130%
      riskLevel: ['safe', 'caution', 'risk'][Math.floor(Math.random() * 3)],
      metadata: {
        skillsAvailable: ['Spanish', 'Technical'],
        peakHour: false
      }
    });
  }

  return data;
}
```

### Previous Story Insights

From Story 2.1:
- Coverage calculator target: < 500ms for 672 intervals
- Unit tests already exist for calculator

From Story 2.2:
- React.memo implemented on HeatmapCell
- useMemo used for grid transformation

From Story 2.6:
- Real-time update flow established
- Performance considerations documented

---

## Testing

### Test Framework
- **Tool:** Vitest 1.2+ with React Testing Library 14.1+
- **Location:** `src/components/CvDHeatmap/CvDHeatmap.perf.test.tsx`
- **Additional Tools:** Chrome DevTools (Profiler, Performance, Memory), Vite build analyzer

[Source: architecture/testing-strategy.md#Frontend Tests]

### Performance Test Suite

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, renderHook, fireEvent } from '@testing-library/react';
import { CvDHeatmap } from './CvDHeatmap';
import { useStore } from '@/stores/appStore';

describe('Heatmap Performance Tests', () => {
  beforeEach(() => {
    // Setup: Load mock demo data
    const mockCvdData = generateMockCvDData(672);
    useStore.setState({ cvdData: mockCvdData, isLoading: false, error: null });
  });

  it('should render heatmap within 200ms', () => {
    const start = performance.now();
    const { container } = render(<CvDHeatmap />);
    const duration = performance.now() - start;

    expect(duration).toBeLessThan(200);
    expect(container.querySelectorAll('.heatmap-cell')).toHaveLength(672);

    console.log(`✅ Heatmap rendered in ${duration.toFixed(2)}ms`);
  });

  it('should recalculate coverage within 500ms', () => {
    const { result } = renderHook(() => useStore());

    const start = performance.now();
    result.current.recalculateCvD();
    const duration = performance.now() - start;

    expect(duration).toBeLessThan(500);
    console.log(`✅ Coverage recalculated in ${duration.toFixed(2)}ms`);
  });

  it('should handle rapid tooltip interactions smoothly', () => {
    const { container } = render(<CvDHeatmap />);
    const cells = container.querySelectorAll('.heatmap-cell');

    const start = performance.now();

    // Simulate rapid mouse movement over 20 cells
    for (let i = 0; i < 20; i++) {
      fireEvent.mouseEnter(cells[i]);
      fireEvent.mouseLeave(cells[i]);
    }

    const duration = performance.now() - start;

    expect(duration).toBeLessThan(1000); // 20 interactions < 1 second
    console.log(`✅ Rapid hover test completed in ${duration.toFixed(2)}ms`);
  });

  it('should open modal within 200ms', async () => {
    const { container } = render(<CvDHeatmap />);
    const firstCell = container.querySelector('.heatmap-cell');

    const start = performance.now();
    fireEvent.click(firstCell!);
    const duration = performance.now() - start;

    expect(duration).toBeLessThan(200);
    console.log(`✅ Modal opened in ${duration.toFixed(2)}ms`);
  });

  it('should not cause memory leaks after multiple updates', () => {
    const { result } = renderHook(() => useStore());

    // Simulate 20 activity changes
    for (let i = 0; i < 20; i++) {
      result.current.addActivity({
        id: `test-${i}`,
        agentId: 'agent-1',
        type: 'meeting',
        // ... minimal required fields
      });

      result.current.deleteActivity(`test-${i}`);
    }

    // Memory leak detection would require browser DevTools
    // This test ensures no crashes occur during rapid changes
    expect(result.current.cvdData).toBeDefined();
    console.log(`✅ No crashes after 20 activity changes`);
  });
});
```

[Source: architecture/testing-strategy.md#Performance Tests]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Story created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

*To be populated by dev agent during implementation*

### Debug Log References

*To be populated by dev agent during implementation*

### Completion Notes List

*PERFORMANCE TEST RESULTS TO BE DOCUMENTED HERE*

Example format:
```
=== Heatmap Performance Test Results ===

Initial Render: [ ] PASS / [ ] FAIL (___ms / 200ms target)
Coverage Recalc: [ ] PASS / [ ] FAIL (___ms / 500ms target)
Tooltip Interaction: [ ] PASS / [ ] FAIL
Modal Open: [ ] PASS / [ ] FAIL (___ms / 200ms target)
Bundle Size: [ ] PASS / [ ] FAIL (___KB / 100KB target)
Memory Leak: [ ] PASS / [ ] FAIL

Optimizations Applied:
- [ List any optimizations implemented ]

Chrome DevTools Screenshots:
- [ Attach or reference screenshots if applicable ]
```

### File List

*To be populated by dev agent during implementation*

---

## QA Results

*To be populated by QA agent after story review*

---

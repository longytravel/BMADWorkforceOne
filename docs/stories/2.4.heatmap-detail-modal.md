# Story 2.4: Heatmap Detail Modal

**Epic:** Epic 2 - CvD Heatmap & Coverage Intelligence
**Story Points:** 5
**Priority:** P1 - High

---

## Status

Ready for Review

---

## Story

**As a** WFM planner,
**I want** to click on a heatmap cell and see a detailed modal with agents scheduled, skills breakdown, and forecasted volume,
**so that** I can investigate coverage details and understand which agents are contributing to service levels in that time slot.

---

## Acceptance Criteria

1. **Given** I click on a heatmap cell, **When** the modal opens, **Then** it should display the time interval header (e.g., "Monday 14:00-14:15")
2. **Given** the modal is open, **When** viewing coverage summary, **Then** it should show coverage percentage, scheduled agents count, and forecasted demand
3. **Given** the modal is open, **When** viewing scheduled agents, **Then** it should display a list of agents working during that interval with their names
4. **Given** the modal is open, **When** viewing agent details, **Then** each agent should show their assigned activity type (shift, break, lunch, etc.) for that interval
5. **Given** the modal is open, **When** viewing skills breakdown, **Then** it should display available skills with count (e.g., "Spanish: 4 agents, Technical: 3 agents")
6. **Given** the modal is open, **When** I click the close button or press Escape, **Then** the modal should close and return to the heatmap view
7. **Given** the modal is open, **When** I click outside the modal content area, **Then** the modal should close
8. **Given** the modal displays agent list, **When** there are many agents (>10), **Then** the list should be scrollable within the modal

---

## Tasks / Subtasks

- [x] Create HeatmapDetailModal component (AC: 1, 2, 6, 7)
  - [x] Create src/components/CvDHeatmap/HeatmapDetailModal.tsx
  - [x] Use Shadcn Dialog component as base
  - [x] Accept dataPoint prop (CvDDataPoint type)
  - [x] Accept isOpen and onClose props for modal control
  - [x] Implement header with time interval display
  - [x] Implement close button (X icon)
  - [x] Support Escape key to close (Dialog handles this)
  - [x] Support click-outside to close (Dialog handles this)

- [x] Implement coverage summary section (AC: 2)
  - [x] Display coverage percentage with color-coded badge (green/yellow/red)
  - [x] Display scheduled agents count
  - [x] Display forecasted demand (calls)
  - [x] Use Card or similar Shadcn component for layout

- [x] Implement scheduled agents list (AC: 3, 4, 8)
  - [x] Query Zustand store for agents scheduled in this interval
  - [x] Filter activities that overlap with intervalStart time
  - [x] Display agent name and activity type
  - [x] Show activity type badge with color coding (shift=blue, break=orange, etc.)
  - [x] Make list scrollable if > 10 agents (max-height: 240px with overflow-y-auto)
  - [x] If > 20 agents, implement "Show more" button or pagination (recommended)
  - [x] Handle edge case: No agents scheduled (display "No agents scheduled")

- [x] Implement skills breakdown section (AC: 5)
  - [x] Extract skills from scheduled agents
  - [x] Aggregate skill counts (e.g., { Spanish: 4, Technical: 3 })
  - [x] Display skills with counts in badge format
  - [x] Sort skills by count (descending)
  - [x] Handle edge case: No skills (display "No skills data")

- [x] Integrate modal with HeatmapCell (AC: 1, 6)
  - [x] Update HeatmapCell.tsx to support onClick handler
  - [x] Add state management for selected cell (useState or lift to CvDHeatmap)
  - [x] Pass selected dataPoint to HeatmapDetailModal
  - [x] Open modal when cell is clicked
  - [x] Close modal when onClose callback is triggered

- [x] Style modal for professional appearance
  - [x] Use Shadcn Dialog styling (white background, shadow, rounded corners)
  - [x] Add section headers (h3 for "Coverage Summary", "Scheduled Agents", "Skills Breakdown")
  - [x] Apply Tailwind spacing and typography classes
  - [x] Ensure modal is centered on screen
  - [x] Add smooth animation (fade-in, scale)

- [x] Write component tests (AC: 1, 2, 3, 5, 6, 7)
  - [x] Create src/components/CvDHeatmap/HeatmapDetailModal.test.tsx
  - [x] Test modal opens when isOpen=true
  - [x] Test modal displays correct time interval
  - [x] Test modal displays coverage summary
  - [x] Test modal displays agent list
  - [x] Test modal displays skills breakdown
  - [x] Test modal closes on Escape key
  - [x] Test modal closes on click outside

---

## Dev Notes

### Architecture Context

This story implements the **click-to-detail interaction** for the heatmap, allowing users to drill down into coverage data. The modal provides comprehensive information about agents, skills, and capacity for a specific 15-minute interval.

### Component Architecture (Source: architecture/frontend-architecture.md)

**Updated Component Structure:**
```
/src/components/CvDHeatmap/
  CvDHeatmap.tsx           # Main heatmap
  HeatmapCell.tsx          # Cell with click support (updated)
  HeatmapTooltip.tsx       # Hover tooltips (Story 2.3)
  HeatmapDetailModal.tsx   # NEW: Detail modal
  index.ts
```

**Modal Component Pattern:**
```typescript
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Badge } from '@/components/ui/badge';
import { Card } from '@/components/ui/card';
import type { CvDDataPoint } from '@/types';

interface HeatmapDetailModalProps {
  dataPoint: CvDDataPoint | null;
  isOpen: boolean;
  onClose: () => void;
}

export function HeatmapDetailModal({ dataPoint, isOpen, onClose }: HeatmapDetailModalProps) {
  if (!dataPoint) return null;

  const scheduledAgents = useScheduledAgentsForInterval(dataPoint.intervalStart);
  const skillsBreakdown = aggregateSkills(scheduledAgents);

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {dataPoint.dayOfWeek} {dataPoint.timeSlot}-{getEndTime(dataPoint.timeSlot)}
          </DialogTitle>
        </DialogHeader>

        {/* Coverage Summary */}
        <Card>
          <h3>Coverage Summary</h3>
          <p>Coverage: {dataPoint.coveragePercent}%</p>
          <p>Agents: {dataPoint.scheduledAgents}</p>
          <p>Demand: {dataPoint.forecastedCalls} calls</p>
        </Card>

        {/* Scheduled Agents */}
        <div>
          <h3>Scheduled Agents</h3>
          <div className="max-h-60 overflow-y-auto">
            {scheduledAgents.map(agent => (
              <div key={agent.id}>
                {agent.name} - <Badge>{agent.activityType}</Badge>
              </div>
            ))}
          </div>
        </div>

        {/* Skills Breakdown */}
        <div>
          <h3>Skills Breakdown</h3>
          {Object.entries(skillsBreakdown).map(([skill, count]) => (
            <Badge key={skill}>{skill}: {count}</Badge>
          ))}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

[Source: architecture/frontend-architecture.md#Component Template Example]

### Data Models (Source: architecture/data-models.md)

**CvDDataPoint Interface:**
```typescript
interface CvDDataPoint {
  intervalStart: string; // ISO 8601
  dayOfWeek: string;
  timeSlot: string;
  forecastedCalls: number;
  scheduledAgents: number;
  coveragePercent: number;
  riskLevel: RiskLevel;
  metadata: {
    skillsAvailable: string[];
    peakHour: boolean;
  };
}
```

**Agent Interface:**
```typescript
interface Agent {
  id: string;
  name: string;
  email: string;
  skills: string[];
  team: string;
  // ... other fields
}
```

**Activity Interface:**
```typescript
interface Activity {
  id: string;
  agentId: string;
  type: ActivityType;
  title: string;
  startDateTime: string; // ISO 8601
  endDateTime: string;
  // ... other fields
}
```

[Source: architecture/data-models.md#CvDDataPoint, #Agent, #Activity]

### State Management (Source: architecture/frontend-architecture.md)

**Zustand Store Access:**
```typescript
const agents = useStore((state) => state.agents);
const activities = useStore((state) => state.activities);
```

**Custom Hook for Scheduled Agents:**
```typescript
// Create this helper hook in src/hooks/useScheduledAgentsForInterval.ts
import { useStore } from '@/stores/appStore';
import { isWithinInterval, parseISO } from 'date-fns';

export function useScheduledAgentsForInterval(intervalStart: string) {
  const agents = useStore((state) => state.agents);
  const activities = useStore((state) => state.activities);

  return useMemo(() => {
    const interval = {
      start: parseISO(intervalStart),
      end: parseISO(intervalStart) + 15 minutes
    };

    // Find all activities overlapping this interval
    const overlappingActivities = activities.filter(activity =>
      isWithinInterval(parseISO(activity.startDateTime), interval) ||
      isWithinInterval(parseISO(activity.endDateTime), interval)
    );

    // Map activities to agents
    return overlappingActivities.map(activity => {
      const agent = agents.find(a => a.id === activity.agentId);
      return {
        ...agent,
        activityType: activity.type,
        activityTitle: activity.title
      };
    });
  }, [intervalStart, agents, activities]);
}
```

[Source: architecture/frontend-architecture.md#State Management Architecture]

### Source Tree (Source: architecture/unified-project-structure.md)

**File Locations:**
- Modal Component: `src/components/CvDHeatmap/HeatmapDetailModal.tsx`
- Custom Hook: `src/hooks/useScheduledAgentsForInterval.ts`
- Updated Cell: `src/components/CvDHeatmap/HeatmapCell.tsx` (add onClick)
- Tests: `src/components/CvDHeatmap/HeatmapDetailModal.test.tsx`
- Shadcn Dialog: `src/components/ui/dialog.tsx` (if not already installed)

**Shadcn Components Installation:**
```bash
npx shadcn@latest add dialog -y
npx shadcn@latest add badge -y
npx shadcn@latest add card -y
```

[Source: architecture/unified-project-structure.md#src/components]

### Tech Stack (Source: architecture/tech-stack.md)

**Key Technologies:**
- **Shadcn/ui:** Dialog, Badge, Card components
- **Radix UI:** Dialog primitive (accessible, auto-focus, Escape handling)
- **date-fns:** 3.0+ (time interval calculations)
- **React:** 18.2+ (useState for modal open/close state)
- **Zustand:** 4.5+ (access agents and activities data)

[Source: architecture/tech-stack.md#Technology Stack Table]

### Coding Standards (Source: architecture/coding-standards.md)

- **Component Composition:** Modal is a separate component, not inline in heatmap
- **Accessibility Required:** Dialog must trap focus, support Escape key, manage aria attributes
- **Memoization:** useScheduledAgentsForInterval uses useMemo to prevent recalculations

**Activity Type Color Mapping:**
```typescript
const ActivityColors = {
  shift: 'bg-blue-500',
  break: 'bg-orange-500',
  lunch: 'bg-purple-500',
  meeting: 'bg-green-500',
  training: 'bg-teal-500',
  'off-phone': 'bg-yellow-500',
  unavailable: 'bg-gray-500'
} as const;
```

[Source: architecture/coding-standards.md#Accessibility Required]

### Skills Aggregation Logic

**Algorithm:**
```typescript
function aggregateSkills(scheduledAgents: Array<Agent & { activityType: string }>) {
  const skillCounts: Record<string, number> = {};

  scheduledAgents.forEach(agent => {
    agent.skills.forEach(skill => {
      skillCounts[skill] = (skillCounts[skill] || 0) + 1;
    });
  });

  // Sort by count descending
  return Object.entries(skillCounts)
    .sort(([, a], [, b]) => b - a)
    .reduce((acc, [skill, count]) => {
      acc[skill] = count;
      return acc;
    }, {} as Record<string, number>);
}
```

**Example Output:**
```javascript
{
  "Spanish": 5,
  "Technical Support": 4,
  "Sales": 3,
  "Billing": 2
}
```

### Modal Click Interaction Flow

**State Management:**
```typescript
// In CvDHeatmap.tsx or HeatmapCell.tsx
const [selectedDataPoint, setSelectedDataPoint] = useState<CvDDataPoint | null>(null);

// Cell onClick handler
<HeatmapCell
  dataPoint={dataPoint}
  onClick={() => setSelectedDataPoint(dataPoint)}
/>

// Modal
<HeatmapDetailModal
  dataPoint={selectedDataPoint}
  isOpen={selectedDataPoint !== null}
  onClose={() => setSelectedDataPoint(null)}
/>
```

**Accessibility:**
- Radix Dialog automatically manages focus trap
- Escape key handled by Dialog primitive
- Click outside handled by Dialog primitive
- Screen reader announcements for modal open/close

### Time Interval Helper (Reuse from Story 2.3)

```typescript
const getEndTime = (startTime: string): string => {
  const [hours, minutes] = startTime.split(':').map(Number);
  const endMinutes = (minutes + 15) % 60;
  const endHours = minutes + 15 >= 60 ? hours + 1 : hours;
  return `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
};
```

### Edge Cases to Handle

1. **No Agents Scheduled:**
   - Display: "No agents scheduled for this interval"
   - Empty skills breakdown

2. **Many Agents:**
   - **10-20 agents:** Scrollable list with max-height (240px, overflow-y-auto)
   - **>20 agents:** Implement "Show more" button for better UX
     ```typescript
     const [showAll, setShowAll] = useState(false);
     const displayedAgents = showAll ? scheduledAgents : scheduledAgents.slice(0, 20);

     {!showAll && scheduledAgents.length > 20 && (
       <Button variant="outline" onClick={() => setShowAll(true)}>
         Show {scheduledAgents.length - 20} more agents
       </Button>
     )}
     ```

3. **No Skills Data:**
   - Display: "No skills information available"

4. **Zero Demand:**
   - Display: "No forecasted demand for this interval"

### Modal Layout Design

**Structure:**
```
┌────────────────────────────────────┐
│ Monday 14:00-14:15           [X]  │ ← Header
├────────────────────────────────────┤
│ Coverage Summary                   │
│ ┌────────────────────────────────┐ │
│ │ Coverage: 120% (Safe)         │ │
│ │ Agents: 12                     │ │
│ │ Demand: 10 calls               │ │
│ └────────────────────────────────┘ │
│                                    │
│ Scheduled Agents                   │
│ ┌────────────────────────────────┐ │
│ │ Alice Johnson - [Shift]       │ │ ← Scrollable
│ │ Bob Smith - [Shift]           │ │
│ │ Carol Davis - [Break]         │ │
│ │ ... (scroll for more)         │ │
│ └────────────────────────────────┘ │
│                                    │
│ Skills Breakdown                   │
│ [Spanish: 5] [Technical: 4]       │
│ [Sales: 3] [Billing: 2]           │
└────────────────────────────────────┘
```

### Previous Story Insights

From Story 2.2:
- HeatmapCell component exists with click support capability
- Cell dataPoint contains all necessary information

From Story 2.3:
- Time interval formatting logic established (reuse getEndTime)

---

## Testing

### Test Framework
- **Tool:** Vitest 1.2+ with React Testing Library 14.1+
- **Location:** `src/components/CvDHeatmap/HeatmapDetailModal.test.tsx`

[Source: architecture/testing-strategy.md#Frontend Tests]

### Component Integration Tests

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { HeatmapDetailModal } from './HeatmapDetailModal';

describe('HeatmapDetailModal', () => {
  const mockDataPoint = {
    intervalStart: '2025-10-20T14:00:00Z',
    dayOfWeek: 'Monday',
    timeSlot: '14:00',
    forecastedCalls: 10,
    scheduledAgents: 3,
    coveragePercent: 120,
    riskLevel: 'safe' as const,
    metadata: { skillsAvailable: ['Spanish', 'Technical'], peakHour: false }
  };

  it('should display time interval header', () => {
    render(
      <HeatmapDetailModal
        dataPoint={mockDataPoint}
        isOpen={true}
        onClose={() => {}}
      />
    );

    expect(screen.getByText(/Monday 14:00-14:15/i)).toBeInTheDocument();
  });

  it('should display coverage summary', () => {
    render(
      <HeatmapDetailModal
        dataPoint={mockDataPoint}
        isOpen={true}
        onClose={() => {}}
      />
    );

    expect(screen.getByText(/Coverage: 120%/i)).toBeInTheDocument();
    expect(screen.getByText(/Agents: 3/i)).toBeInTheDocument();
    expect(screen.getByText(/Demand: 10 calls/i)).toBeInTheDocument();
  });

  it('should close modal on Escape key', () => {
    const onClose = vi.fn();
    render(
      <HeatmapDetailModal
        dataPoint={mockDataPoint}
        isOpen={true}
        onClose={onClose}
      />
    );

    fireEvent.keyDown(window, { key: 'Escape' });
    expect(onClose).toHaveBeenCalled();
  });

  it('should display scheduled agents list', () => {
    // Mock useScheduledAgentsForInterval hook
    // ... implementation depends on testing approach
  });

  it('should display skills breakdown', () => {
    render(
      <HeatmapDetailModal
        dataPoint={mockDataPoint}
        isOpen={true}
        onClose={() => {}}
      />
    );

    expect(screen.getByText(/Spanish/i)).toBeInTheDocument();
    expect(screen.getByText(/Technical/i)).toBeInTheDocument();
  });
});
```

[Source: architecture/testing-strategy.md#Component Test Examples]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Story created | Bob (Scrum Master) |
| 2025-10-19 | 1.1 | Story implemented - All ACs met | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - No blocking issues encountered

### Completion Notes List

- Installed Shadcn Badge component successfully
- Created custom hook `useScheduledAgentsForInterval` to query agents and activities from Zustand store
- Implemented HeatmapDetailModal with all required sections:
  - Coverage summary with color-coded risk badges (safe/caution/risk)
  - Scheduled agents list with activity type badges and scrolling support
  - Skills breakdown with aggregated counts sorted by frequency
  - "Show more" button for >20 agents
- Integrated modal into CvDHeatmap component with state management
- Fixed time calculation edge case for 23:45 → 00:00 transition
- All 13 unit tests passing
- ESLint clean, production build successful
- Full accessibility support via Radix Dialog primitives (focus trap, Escape key, click-outside)

### File List

**New Files:**
- src/components/CvDHeatmap/HeatmapDetailModal.tsx
- src/components/CvDHeatmap/HeatmapDetailModal.test.tsx
- src/hooks/useScheduledAgentsForInterval.ts
- src/components/ui/badge.tsx

**Modified Files:**
- src/components/CvDHeatmap/CvDHeatmap.tsx (added modal state and integration)
- src/components/CvDHeatmap/index.ts (exported HeatmapDetailModal)
- src/hooks/index.ts (exported useScheduledAgentsForInterval hook)

---

## QA Results

*To be populated by QA agent after story review*

---

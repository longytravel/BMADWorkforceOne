# Story 2.7: Heatmap Legend & Color Key

**Epic:** Epic 2 - CvD Heatmap & Coverage Intelligence
**Story Points:** 2
**Priority:** P2 - Medium

---

## Status

Ready

---

## Story

**As a** WFM planner,
**I want** a color legend explaining what green, yellow, and red cells represent,
**so that** I can quickly understand the heatmap's risk levels and coverage thresholds without needing to hover over cells.

---

## Acceptance Criteria

1. **Given** the heatmap page loads, **When** I view the legend, **Then** it should display three color indicators: green, yellow, and red
2. **Given** the legend is displayed, **When** I read the green indicator, **Then** it should show "Safe (>105% coverage)" with a green color swatch
3. **Given** the legend is displayed, **When** I read the yellow indicator, **Then** it should show "Caution (90-105% coverage)" with a yellow color swatch
4. **Given** the legend is displayed, **When** I read the red indicator, **Then** it should show "Risk (<90% coverage)" with a red color swatch
5. **Given** the legend is displayed, **When** viewing its position, **Then** it should be placed near the heatmap (above, below, or to the side) for easy reference
6. **Given** the legend is displayed, **When** on mobile/tablet, **Then** it should remain visible and readable without overlapping the heatmap
7. **Given** the legend is displayed, **When** I view it, **Then** it should use the exact same colors as the heatmap cells (#10B981 green, #FBBF24 yellow, #EF4444 red)
8. **Given** the legend is displayed, **When** viewed, **Then** it should include a brief title or label (e.g., "Coverage Risk Levels")

---

## Tasks / Subtasks

- [ ] Create HeatmapLegend component (AC: 1, 2, 3, 4, 7, 8)
  - [ ] Create src/components/CvDHeatmap/HeatmapLegend.tsx
  - [ ] Display legend title: "Coverage Risk Levels"
  - [ ] Create three legend items with color swatches
  - [ ] Safe: Green (#10B981) - ">105% coverage"
  - [ ] Caution: Yellow (#FBBF24) - "90-105% coverage"
  - [ ] Risk: Red (#EF4444) - "<90% coverage"
  - [ ] Use Tailwind for layout and styling

- [ ] Integrate legend into Dashboard/Heatmap Page (AC: 5, 6)
  - [ ] Import HeatmapLegend in Dashboard.tsx or CvDHeatmap.tsx
  - [ ] Position legend above or below heatmap
  - [ ] Apply responsive layout (flex or grid)
  - [ ] Ensure legend doesn't overlap heatmap on small screens

- [ ] Style legend for professional appearance (AC: 7)
  - [ ] Use consistent color swatches (rounded squares or circles)
  - [ ] Apply readable typography (text-sm or text-base)
  - [ ] Add spacing between legend items
  - [ ] Optional: Add subtle border or background for visual grouping

- [ ] Add accessibility features
  - [ ] Use semantic HTML (e.g., `<ul>` for legend items)
  - [ ] Add aria-label to legend container
  - [ ] Ensure color contrast for text readability

- [ ] Write component tests (AC: 1, 2, 3, 4, 7)
  - [ ] Create src/components/CvDHeatmap/HeatmapLegend.test.tsx
  - [ ] Test legend renders with three items
  - [ ] Test correct colors are applied (green, yellow, red)
  - [ ] Test correct labels are displayed
  - [ ] Test legend title is present

---

## Dev Notes

### Architecture Context

This story adds a **visual legend** to help users understand the heatmap's color coding. The legend is a simple, static UI component that displays the three risk levels and their corresponding colors.

### Component Architecture (Source: architecture/frontend-architecture.md)

**Component Structure:**
```
/src/components/CvDHeatmap/
  CvDHeatmap.tsx          # Main heatmap
  HeatmapCell.tsx         # Individual cell
  HeatmapTooltip.tsx      # Hover tooltip
  HeatmapDetailModal.tsx  # Click detail
  HeatmapLegend.tsx       # NEW: Color legend
  index.ts
```

**Legend Component Pattern:**
```typescript
// src/components/CvDHeatmap/HeatmapLegend.tsx

const LEGEND_ITEMS = [
  { color: '#10B981', label: 'Safe', description: '>105% coverage' },
  { color: '#FBBF24', label: 'Caution', description: '90-105% coverage' },
  { color: '#EF4444', label: 'Risk', description: '<90% coverage' },
] as const;

export function HeatmapLegend() {
  return (
    <div className="flex items-center gap-6 p-4 bg-gray-50 rounded-lg" aria-label="Coverage risk level legend">
      <h3 className="text-sm font-semibold text-gray-700">Coverage Risk Levels:</h3>

      <ul className="flex gap-4">
        {LEGEND_ITEMS.map(({ color, label, description }) => (
          <li key={label} className="flex items-center gap-2">
            <div
              className="w-4 h-4 rounded"
              style={{ backgroundColor: color }}
              aria-hidden="true"
            />
            <span className="text-sm">
              <strong>{label}</strong> ({description})
            </span>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

[Source: architecture/frontend-architecture.md#Component Template Example]

### Integration into Dashboard

**Dashboard.tsx Integration:**
```typescript
// src/pages/Dashboard.tsx
import { CvDHeatmap } from '@/components/CvDHeatmap';
import { HeatmapLegend } from '@/components/CvDHeatmap';

export function Dashboard() {
  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-2">Capacity vs Demand Heatmap</h1>
      <p className="text-gray-600 mb-6">
        Real-time coverage visualization across 7 days
      </p>

      {/* Legend positioned above heatmap */}
      <HeatmapLegend />

      <div className="bg-white rounded-lg shadow-lg p-4 mt-4">
        <CvDHeatmap />
      </div>
    </div>
  );
}
```

**Alternative: Legend inside CvDHeatmap component:**
```typescript
// src/components/CvDHeatmap/CvDHeatmap.tsx
export function CvDHeatmap() {
  return (
    <div>
      <HeatmapLegend />
      <div className="heatmap-grid mt-4">
        {/* Grid cells */}
      </div>
    </div>
  );
}
```

### Source Tree (Source: architecture/unified-project-structure.md)

**File Locations:**
- Legend Component: `src/components/CvDHeatmap/HeatmapLegend.tsx`
- Updated Dashboard: `src/pages/Dashboard.tsx`
- Tests: `src/components/CvDHeatmap/HeatmapLegend.test.tsx`
- Index: `src/components/CvDHeatmap/index.ts` (add HeatmapLegend export)

[Source: architecture/unified-project-structure.md#src/components]

### Tech Stack (Source: architecture/tech-stack.md)

**Key Technologies:**
- **React:** 18.2+ (functional component)
- **Tailwind CSS:** 3.4+ (styling and layout)

No external UI libraries needed - pure HTML + Tailwind.

[Source: architecture/tech-stack.md#CSS Framework]

### Coding Standards (Source: architecture/coding-standards.md)

- **Accessibility Required:** Use semantic HTML (`<ul>`, `<li>`), aria-label
- **Component Composition:** Legend is a separate, reusable component
- **Color Constants:** Use exact colors from heatmap (#10B981, #FBBF24, #EF4444)

**Color Swatch Options:**
```typescript
// Option 1: Rounded square
<div className="w-4 h-4 rounded" style={{ backgroundColor: color }} />

// Option 2: Circle
<div className="w-4 h-4 rounded-full" style={{ backgroundColor: color }} />

// Option 3: Rectangle
<div className="w-8 h-4 rounded" style={{ backgroundColor: color }} />
```

[Source: architecture/coding-standards.md#Accessibility Required]

### Legend Layout Options

**Option 1: Horizontal Layout (Recommended)**
```
Coverage Risk Levels: [Green] Safe (>105%)  [Yellow] Caution (90-105%)  [Red] Risk (<90%)
```

**Option 2: Vertical Layout (for sidebar)**
```
Coverage Risk Levels:
  [Green] Safe (>105%)
  [Yellow] Caution (90-105%)
  [Red] Risk (<90%)
```

**Option 3: Compact (for small screens)**
```
[Green] Safe  [Yellow] Caution  [Red] Risk
```

**Recommendation:** Use horizontal layout above/below heatmap for desktop, stack vertically on mobile if needed.

### Responsive Design

**Desktop (>= 1024px):**
```typescript
<div className="flex items-center gap-6">
  {/* Horizontal layout */}
</div>
```

**Mobile/Tablet (< 1024px):**
```typescript
<div className="flex flex-col lg:flex-row lg:items-center gap-4">
  {/* Vertical on mobile, horizontal on desktop */}
</div>
```

**Alternative: Always horizontal with wrap:**
```typescript
<div className="flex flex-wrap items-center gap-4">
  {/* Wraps to next line on small screens */}
</div>
```

### Accessibility Considerations

**Semantic HTML:**
```typescript
<div aria-label="Coverage risk level legend" role="region">
  <h3 id="legend-title">Coverage Risk Levels</h3>
  <ul aria-labelledby="legend-title">
    <li>
      <span className="sr-only">Safe coverage:</span>
      <div className="swatch" aria-hidden="true" />
      <span>Safe (>105% coverage)</span>
    </li>
    {/* ... */}
  </ul>
</div>
```

**Screen Reader Support:**
- Color swatches have `aria-hidden="true"` (not meaningful for screen readers)
- Text labels provide full information
- `sr-only` class adds context for screen readers

### Visual Design Examples

**Example 1: Card Style**
```typescript
<div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
  <h3 className="text-sm font-semibold text-gray-700 mb-3">Coverage Risk Levels</h3>
  <div className="flex gap-4">
    {/* Legend items */}
  </div>
</div>
```

**Example 2: Inline Style**
```typescript
<div className="flex items-center gap-6 py-3 px-4 bg-gray-50 rounded">
  <span className="text-sm font-medium text-gray-600">Legend:</span>
  {/* Legend items */}
</div>
```

**Example 3: Minimal Style**
```typescript
<div className="flex gap-6 text-sm">
  {/* Legend items only, no container */}
</div>
```

**Recommendation:** Use Card Style or Inline Style for visual distinction from heatmap.

### Color Swatch Styling

**Rounded Square (Recommended):**
```typescript
<div
  className="w-4 h-4 rounded border border-gray-300"
  style={{ backgroundColor: color }}
/>
```

**Circle:**
```typescript
<div
  className="w-4 h-4 rounded-full border border-gray-300"
  style={{ backgroundColor: color }}
/>
```

**Rectangle:**
```typescript
<div
  className="w-12 h-3 rounded"
  style={{ backgroundColor: color }}
/>
```

### Typography & Spacing

**Font Sizes:**
- Title: `text-sm` or `text-base` (font-semibold)
- Labels: `text-sm` (font-medium or font-normal)
- Descriptions: `text-sm` (text-gray-600)

**Spacing:**
- Between swatch and label: `gap-2`
- Between legend items: `gap-4` or `gap-6`
- Container padding: `p-4`

### Integration with Heatmap

**Placement Options:**

**Option 1: Above Heatmap**
```typescript
<div>
  <HeatmapLegend />
  <div className="mt-4">
    <CvDHeatmap />
  </div>
</div>
```

**Option 2: Below Heatmap**
```typescript
<div>
  <CvDHeatmap />
  <div className="mt-4">
    <HeatmapLegend />
  </div>
</div>
```

**Option 3: Side-by-Side (for wide screens)**
```typescript
<div className="flex gap-4">
  <div className="flex-1">
    <CvDHeatmap />
  </div>
  <div className="w-64">
    <HeatmapLegend />
  </div>
</div>
```

**Recommendation:** Place above heatmap for immediate visibility.

### Previous Story Insights

From Story 2.2:
- Heatmap uses colors #10B981 (green), #FBBF24 (yellow), #EF4444 (red)
- Risk level thresholds established: <90%, 90-105%, >105%

---

## Testing

### Test Framework
- **Tool:** Vitest 1.2+ with React Testing Library 14.1+
- **Location:** `src/components/CvDHeatmap/HeatmapLegend.test.tsx`

[Source: architecture/testing-strategy.md#Frontend Tests]

### Component Tests

```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { HeatmapLegend } from './HeatmapLegend';

describe('HeatmapLegend', () => {
  it('should render legend title', () => {
    render(<HeatmapLegend />);
    expect(screen.getByText(/Coverage Risk Levels/i)).toBeInTheDocument();
  });

  it('should render three legend items', () => {
    const { container } = render(<HeatmapLegend />);
    const legendItems = container.querySelectorAll('li');
    expect(legendItems).toHaveLength(3);
  });

  it('should display correct labels and descriptions', () => {
    render(<HeatmapLegend />);

    expect(screen.getByText(/Safe/i)).toBeInTheDocument();
    expect(screen.getByText(/>105% coverage/i)).toBeInTheDocument();

    expect(screen.getByText(/Caution/i)).toBeInTheDocument();
    expect(screen.getByText(/90-105% coverage/i)).toBeInTheDocument();

    expect(screen.getByText(/Risk/i)).toBeInTheDocument();
    expect(screen.getByText(/<90% coverage/i)).toBeInTheDocument();
  });

  it('should apply correct colors to swatches', () => {
    const { container } = render(<HeatmapLegend />);

    const swatches = container.querySelectorAll('[style*="backgroundColor"]');

    expect(swatches[0]).toHaveStyle({ backgroundColor: '#10B981' }); // Green
    expect(swatches[1]).toHaveStyle({ backgroundColor: '#FBBF24' }); // Yellow
    expect(swatches[2]).toHaveStyle({ backgroundColor: '#EF4444' }); // Red
  });
});
```

[Source: architecture/testing-strategy.md#Component Test Examples]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 1.0 | Story created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

*To be populated by dev agent during implementation*

### Debug Log References

*To be populated by dev agent during implementation*

### Completion Notes List

*To be populated by dev agent during implementation*

### File List

*To be populated by dev agent during implementation*

---

## QA Results

*To be populated by QA agent after story review*

---

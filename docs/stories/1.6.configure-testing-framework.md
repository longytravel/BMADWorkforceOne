# Story 1.6: Configure Testing Framework

**Epic:** Epic 1 - Foundation & Demo Infrastructure
**Story Points:** 3
**Priority:** P0 - Critical

---

## Status

Ready for Review

---

## Story

**As a** developer,
**I want** to configure Vitest and React Testing Library with proper setup and example tests,
**so that** all subsequent features can be developed with test-driven development (TDD) and quality assurance.

---

## Acceptance Criteria

1. **Given** I need to run unit tests, **When** I execute `npm run test`, **Then** Vitest should run successfully with proper configuration
2. **Given** I need to test React components, **When** I import from `@testing-library/react`, **Then** React Testing Library should be properly configured with jsdom environment
3. **Given** I need test utilities, **When** I create `src/test/setup.ts`, **Then** global test setup (jest-dom matchers, cleanup) should be configured
4. **Given** I write a test, **When** I use Vitest globals (describe, it, expect), **Then** they should be available without imports
5. **Given** I need to validate demo data, **When** I create a test for data loading, **Then** the test should pass with the JSON files from Story 1.4
6. **Given** I need coverage reports, **When** I run `npm run test:coverage`, **Then** I should see a coverage report with thresholds configured

---

## Tasks / Subtasks

- [x] Install testing dependencies (AC: 1, 2)
  - [x] Run `npm install -D vitest @vitejs/plugin-react` (Vitest core)
  - [x] Run `npm install -D @testing-library/react @testing-library/jest-dom @testing-library/user-event` (React testing)
  - [x] Run `npm install -D jsdom` (DOM environment for tests)
  - [x] Run `npm install -D @vitest/coverage-v8` (Code coverage)

- [x] Create vitest.config.ts (AC: 1, 4)
  - [x] Create `vitest.config.ts` at project root
  - [x] Configure globals: true (for describe, it, expect without imports)
  - [x] Configure environment: 'jsdom' (for DOM APIs)
  - [x] Configure setupFiles: './src/test/setup.ts'
  - [x] Configure coverage provider: 'v8' with reporters: text, html
  - [x] Set coverage thresholds: logic/ 80%, components/ 40%
  - [x] Exclude patterns: node_modules, test files, config files

- [x] Create test setup file (AC: 3)
  - [x] Create `src/test/setup.ts`
  - [x] Import '@testing-library/jest-dom' for DOM matchers
  - [x] Configure cleanup after each test
  - [x] Mock window.matchMedia for responsive tests
  - [x] Add any global test utilities

- [x] Update package.json scripts (AC: 1, 6)
  - [x] Add `"test": "vitest"`
  - [x] Add `"test:watch": "vitest --watch"`
  - [x] Add `"test:coverage": "vitest --coverage"`
  - [x] Add `"test:ui": "vitest --ui"` (optional - nice visual test runner)

- [x] Create example unit test for data loader (AC: 5)
  - [x] Create `src/services/dataLoader.ts` (basic structure)
  - [x] Create `src/services/dataLoader.test.ts`
  - [x] Write test: "loads agents.json successfully"
  - [x] Write test: "loads all demo data files in parallel"
  - [x] Write test: "throws error when file not found"
  - [x] Mock fetch() using Vitest mocking
  - [x] Run tests - should pass with Story 1.4 JSON files

- [x] Create example component test (AC: 2)
  - [x] Create simple test for LoadingScreen component
  - [x] Test: "renders loading message"
  - [x] Test: "has aria-live region for accessibility"
  - [x] Use `@testing-library/react` render and screen
  - [x] Run test - should pass

- [x] Verify coverage configuration (AC: 6)
  - [x] Run `npm run test:coverage`
  - [x] Check coverage report generated in `coverage/` folder
  - [x] Verify HTML report opens in browser
  - [x] Confirm thresholds configured (logic 80%, components 40%)

---

## Dev Notes

### vitest.config.ts Configuration

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.ts',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'lcov'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.test.{ts,tsx}',
        '**/*.spec.{ts,tsx}',
        '**/index.ts',
        '**/*.d.ts',
        'vite.config.ts',
        'vitest.config.ts'
      ],
      thresholds: {
        'src/logic/**': {
          statements: 80,
          branches: 80,
          functions: 80,
          lines: 80
        },
        'src/components/**': {
          statements: 40,
          branches: 40,
          functions: 40,
          lines: 40
        }
      }
    }
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

### src/test/setup.ts Configuration

```typescript
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { afterEach } from 'vitest';

// Cleanup after each test
afterEach(() => {
  cleanup();
});

// Mock window.matchMedia for responsive tests
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});
```

### Example Test: dataLoader.test.ts

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { DataLoader } from './dataLoader';

describe('DataLoader', () => {
  beforeEach(() => {
    vi.restoreAllMocks();
  });

  it('loads agents.json successfully', async () => {
    const loader = new DataLoader();
    const agents = await loader.loadAgents();

    expect(agents).toBeDefined();
    expect(agents.length).toBeGreaterThan(0);
    expect(agents[0]).toHaveProperty('id');
    expect(agents[0]).toHaveProperty('name');
    expect(agents[0]).toHaveProperty('skills');
  });

  it('throws error when file not found', async () => {
    global.fetch = vi.fn(() =>
      Promise.resolve({
        ok: false,
        status: 404,
      } as Response)
    );

    const loader = new DataLoader();
    await expect(loader.loadAgents()).rejects.toThrow('Failed to load agents');
  });
});
```

### Example Component Test: LoadingScreen.test.tsx

```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { LoadingScreen } from '@/components/Layout/LoadingScreen';

describe('LoadingScreen', () => {
  it('renders loading message', () => {
    render(<LoadingScreen />);
    expect(screen.getByText(/loading demo data/i)).toBeInTheDocument();
  });

  it('has aria-live region for accessibility', () => {
    render(<LoadingScreen />);
    const loadingElement = screen.getByRole('status');
    expect(loadingElement).toHaveAttribute('aria-live', 'polite');
  });
});
```

### Architecture References

**From Architecture Document (Section: Testing Strategy):**
- Vitest 1.2+ as test runner (Vite-native, fast)
- React Testing Library 14.1+ for component tests
- Coverage targets: 80%+ for `/logic`, 40%+ for `/components`

**From QA Early Test Architecture:**
- P0 tests: IOI calculator, break adjuster, data loader
- P1 tests: Coverage calculator, component integration tests
- Performance benchmarks: IOI <500ms, CvD <100ms

### Testing

**Testing Standards:**
- This story is about setting up the testing infrastructure
- Meta-test: Run `npm run test` - should execute successfully
- Meta-test: Example tests should pass

**Test Validation:**
- Run `npm run test` - Vitest runs, example tests pass
- Run `npm run test:coverage` - Coverage report generated
- Run `npm run test:watch` - Watch mode works, re-runs on file changes
- Vitest globals (describe, it, expect) available without imports

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-10-18 | 1.1 | Story implementation completed | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None - implementation completed without issues requiring debug logging.

### Completion Notes

Successfully configured complete testing framework for the project:

**Testing Infrastructure:**
- Installed Vitest 3.2.4 as test runner with React Testing Library 16.3.0
- Configured jsdom environment for DOM testing
- Set up @vitest/coverage-v8 for code coverage reporting
- Enabled Vitest globals (describe, it, expect) for cleaner test syntax

**Configuration Files:**
- Created vitest.config.ts with coverage thresholds (logic: 80%, components: 40%)
- Created src/test/setup.ts with jest-dom matchers and window.matchMedia mock
- Added 4 test scripts to package.json (test, test:watch, test:coverage, test:ui)
- Updated eslint.config.js to exclude coverage directory from linting

**Example Tests:**
- Created src/services/dataLoader.ts and src/services/dataLoader.test.ts (3 passing tests)
- Created src/components/Layout/LoadingScreen.test.tsx (3 passing tests)
- All 6 tests passing successfully

**Validation:**
- npm run test: ✓ passes (6/6 tests)
- npm run test:coverage: ✓ generates HTML report with configured thresholds
- npm run lint: ✓ passes with no errors
- npm run build: ✓ builds successfully

The testing framework is now fully operational and ready for TDD development in subsequent stories.

### File List

**New Files:**
- vitest.config.ts
- src/test/setup.ts
- src/services/dataLoader.ts
- src/services/dataLoader.test.ts
- src/components/Layout/LoadingScreen.test.tsx

**Modified Files:**
- package.json (added test scripts and dependencies)
- eslint.config.js (excluded coverage directory)

---

## QA Results

*(This section will be populated by QA agent after implementation)*

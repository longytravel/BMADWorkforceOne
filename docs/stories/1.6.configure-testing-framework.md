# Story 1.6: Configure Testing Framework

**Epic:** Epic 1 - Foundation & Demo Infrastructure
**Story Points:** 3
**Priority:** P0 - Critical

---

## Status

Ready for Review

---

## Story

**As a** developer,
**I want** to configure Vitest and React Testing Library with proper setup and example tests,
**so that** all subsequent features can be developed with test-driven development (TDD) and quality assurance.

---

## Acceptance Criteria

1. **Given** I need to run unit tests, **When** I execute `npm run test`, **Then** Vitest should run successfully with proper configuration
2. **Given** I need to test React components, **When** I import from `@testing-library/react`, **Then** React Testing Library should be properly configured with jsdom environment
3. **Given** I need test utilities, **When** I create `src/test/setup.ts`, **Then** global test setup (jest-dom matchers, cleanup) should be configured
4. **Given** I write a test, **When** I use Vitest globals (describe, it, expect), **Then** they should be available without imports
5. **Given** I need to validate demo data, **When** I create a test for data loading, **Then** the test should pass with the JSON files from Story 1.4
6. **Given** I need coverage reports, **When** I run `npm run test:coverage`, **Then** I should see a coverage report with thresholds configured

---

## Tasks / Subtasks

- [x] Install testing dependencies (AC: 1, 2)
  - [x] Run `npm install -D vitest @vitejs/plugin-react` (Vitest core)
  - [x] Run `npm install -D @testing-library/react @testing-library/jest-dom @testing-library/user-event` (React testing)
  - [x] Run `npm install -D jsdom` (DOM environment for tests)
  - [x] Run `npm install -D @vitest/coverage-v8` (Code coverage)

- [x] Create vitest.config.ts (AC: 1, 4)
  - [x] Create `vitest.config.ts` at project root
  - [x] Configure globals: true (for describe, it, expect without imports)
  - [x] Configure environment: 'jsdom' (for DOM APIs)
  - [x] Configure setupFiles: './src/test/setup.ts'
  - [x] Configure coverage provider: 'v8' with reporters: text, html
  - [x] Set coverage thresholds: logic/ 80%, components/ 40%
  - [x] Exclude patterns: node_modules, test files, config files

- [x] Create test setup file (AC: 3)
  - [x] Create `src/test/setup.ts`
  - [x] Import '@testing-library/jest-dom' for DOM matchers
  - [x] Configure cleanup after each test
  - [x] Mock window.matchMedia for responsive tests
  - [x] Add any global test utilities

- [x] Update package.json scripts (AC: 1, 6)
  - [x] Add `"test": "vitest"`
  - [x] Add `"test:watch": "vitest --watch"`
  - [x] Add `"test:coverage": "vitest --coverage"`
  - [x] Add `"test:ui": "vitest --ui"` (optional - nice visual test runner)

- [x] Create example unit test for data loader (AC: 5)
  - [x] Create `src/services/dataLoader.ts` (basic structure)
  - [x] Create `src/services/dataLoader.test.ts`
  - [x] Write test: "loads agents.json successfully"
  - [x] Write test: "loads all demo data files in parallel"
  - [x] Write test: "throws error when file not found"
  - [x] Mock fetch() using Vitest mocking
  - [x] Run tests - should pass with Story 1.4 JSON files

- [x] Create example component test (AC: 2)
  - [x] Create simple test for LoadingScreen component
  - [x] Test: "renders loading message"
  - [x] Test: "has aria-live region for accessibility"
  - [x] Use `@testing-library/react` render and screen
  - [x] Run test - should pass

- [x] Verify coverage configuration (AC: 6)
  - [x] Run `npm run test:coverage`
  - [x] Check coverage report generated in `coverage/` folder
  - [x] Verify HTML report opens in browser
  - [x] Confirm thresholds configured (logic 80%, components 40%)

---

## Dev Notes

### vitest.config.ts Configuration

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.ts',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'lcov'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.test.{ts,tsx}',
        '**/*.spec.{ts,tsx}',
        '**/index.ts',
        '**/*.d.ts',
        'vite.config.ts',
        'vitest.config.ts'
      ],
      thresholds: {
        'src/logic/**': {
          statements: 80,
          branches: 80,
          functions: 80,
          lines: 80
        },
        'src/components/**': {
          statements: 40,
          branches: 40,
          functions: 40,
          lines: 40
        }
      }
    }
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

### src/test/setup.ts Configuration

```typescript
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { afterEach } from 'vitest';

// Cleanup after each test
afterEach(() => {
  cleanup();
});

// Mock window.matchMedia for responsive tests
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});
```

### Example Test: dataLoader.test.ts

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { DataLoader } from './dataLoader';

describe('DataLoader', () => {
  beforeEach(() => {
    vi.restoreAllMocks();
  });

  it('loads agents.json successfully', async () => {
    const loader = new DataLoader();
    const agents = await loader.loadAgents();

    expect(agents).toBeDefined();
    expect(agents.length).toBeGreaterThan(0);
    expect(agents[0]).toHaveProperty('id');
    expect(agents[0]).toHaveProperty('name');
    expect(agents[0]).toHaveProperty('skills');
  });

  it('throws error when file not found', async () => {
    global.fetch = vi.fn(() =>
      Promise.resolve({
        ok: false,
        status: 404,
      } as Response)
    );

    const loader = new DataLoader();
    await expect(loader.loadAgents()).rejects.toThrow('Failed to load agents');
  });
});
```

### Example Component Test: LoadingScreen.test.tsx

```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { LoadingScreen } from '@/components/Layout/LoadingScreen';

describe('LoadingScreen', () => {
  it('renders loading message', () => {
    render(<LoadingScreen />);
    expect(screen.getByText(/loading demo data/i)).toBeInTheDocument();
  });

  it('has aria-live region for accessibility', () => {
    render(<LoadingScreen />);
    const loadingElement = screen.getByRole('status');
    expect(loadingElement).toHaveAttribute('aria-live', 'polite');
  });
});
```

### Architecture References

**From Architecture Document (Section: Testing Strategy):**
- Vitest 1.2+ as test runner (Vite-native, fast)
- React Testing Library 14.1+ for component tests
- Coverage targets: 80%+ for `/logic`, 40%+ for `/components`

**From QA Early Test Architecture:**
- P0 tests: IOI calculator, break adjuster, data loader
- P1 tests: Coverage calculator, component integration tests
- Performance benchmarks: IOI <500ms, CvD <100ms

### Testing

**Testing Standards:**
- This story is about setting up the testing infrastructure
- Meta-test: Run `npm run test` - should execute successfully
- Meta-test: Example tests should pass

**Test Validation:**
- Run `npm run test` - Vitest runs, example tests pass
- Run `npm run test:coverage` - Coverage report generated
- Run `npm run test:watch` - Watch mode works, re-runs on file changes
- Vitest globals (describe, it, expect) available without imports

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-10-18 | 1.1 | Story implementation completed | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None - implementation completed without issues requiring debug logging.

### Completion Notes

Successfully configured complete testing framework for the project:

**Testing Infrastructure:**
- Installed Vitest 3.2.4 as test runner with React Testing Library 16.3.0
- Configured jsdom environment for DOM testing
- Set up @vitest/coverage-v8 for code coverage reporting
- Enabled Vitest globals (describe, it, expect) for cleaner test syntax

**Configuration Files:**
- Created vitest.config.ts with coverage thresholds (logic: 80%, components: 40%)
- Created src/test/setup.ts with jest-dom matchers and window.matchMedia mock
- Added 4 test scripts to package.json (test, test:watch, test:coverage, test:ui)
- Updated eslint.config.js to exclude coverage directory from linting

**Example Tests:**
- Created src/services/dataLoader.ts and src/services/dataLoader.test.ts (3 passing tests)
- Created src/components/Layout/LoadingScreen.test.tsx (3 passing tests)
- All 6 tests passing successfully

**Validation:**
- npm run test: ✓ passes (6/6 tests)
- npm run test:coverage: ✓ generates HTML report with configured thresholds
- npm run lint: ✓ passes with no errors
- npm run build: ✓ builds successfully

The testing framework is now fully operational and ready for TDD development in subsequent stories.

### File List

**New Files:**
- vitest.config.ts
- src/test/setup.ts
- src/services/dataLoader.ts
- src/services/dataLoader.test.ts
- src/components/Layout/LoadingScreen.test.tsx

**Modified Files:**
- package.json (added test scripts and dependencies)
- eslint.config.js (excluded coverage directory)
- vitest.config.ts (QA: corrected component coverage threshold 40% → 50%)

---

## QA Results

### Review Date: 2025-10-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: Excellent ✅**

The testing framework has been configured with high quality and attention to detail. The implementation demonstrates:
- Proper Vitest configuration with jsdom environment for React component testing
- Comprehensive test setup with global utilities (jest-dom matchers, cleanup, matchMedia mock)
- Well-structured example tests covering both service logic and component rendering
- Good test design with separation of concerns and proper mocking strategies
- Accessibility considerations in both implementation and tests

All 6 tests pass successfully, demonstrating a solid foundation for TDD in subsequent stories.

### Refactoring Performed

**File:** [vitest.config.ts](../wfm-intelligence-demo/vitest.config.ts#L31-L36)
- **Change:** Updated component coverage threshold from 40% to 50%
- **Why:** Align with Testing Strategy document which specifies 50%+ for `/components` folder
- **How:** Changed all four threshold metrics (statements, branches, functions, lines) from 40 to 50 to match architectural standard and eliminate discrepancy between docs and implementation
- **Impact:** Tests still pass; no immediate coverage issues; establishes correct baseline for future stories

### Compliance Check

- **Coding Standards:** ✅ PASS
  - TypeScript strict typing used throughout (no `any` types)
  - Proper naming conventions (PascalCase for components, camelCase for functions)
  - Component composition with reusable LoadingScreen
  - Accessibility implemented (aria-live, role attributes)

- **Project Structure:** ✅ PASS
  - Tests co-located with implementation files
  - Service layer properly organized in `src/services/`
  - Test utilities in dedicated `src/test/` folder
  - Configuration files at project root

- **Testing Strategy:** ✅ PASS (after correction)
  - Vitest 3.2.4 configured (exceeds 1.2+ requirement)
  - React Testing Library 16.3.0 configured (exceeds 14.1+ requirement)
  - Coverage targets: 80% for `/logic`, 50% for `/components` ✅ (corrected)
  - jsdom environment configured
  - Example tests demonstrate unit and component testing approaches

- **All ACs Met:** ✅ PASS
  - All 6 acceptance criteria validated and passing
  - Test scripts properly configured in package.json
  - Demo data validation tests operational

### Improvements Checklist

- [x] Corrected coverage threshold to match Testing Strategy (vitest.config.ts)
- [x] Validated all tests pass with corrected configuration
- [x] Verified lint passes with no errors
- [ ] Consider adding TypeScript validation to DataLoader (e.g., Zod schema) in future stories when loading actual demo data
- [ ] Future stories should expand DataLoader.loadAllData() to include schedules, cvd-forecast, compliance-rules per Story 1.4

### Requirements Traceability (Given-When-Then Mapping)

**AC 1: Vitest Execution**
- **Given:** Developer needs to run unit tests
- **When:** Execute `npm run test`
- **Then:** Vitest runs successfully ✅
- **Test Evidence:** All 6 tests passing in 2 test suites

**AC 2: React Testing Library Configuration**
- **Given:** Need to test React components
- **When:** Import from `@testing-library/react`
- **Then:** RTL properly configured with jsdom ✅
- **Test Evidence:** LoadingScreen.test.tsx uses render() and screen successfully

**AC 3: Global Test Setup**
- **Given:** Need test utilities
- **When:** Create src/test/setup.ts
- **Then:** Global setup configured ✅
- **Test Evidence:** jest-dom matchers, cleanup, matchMedia mock present and functional

**AC 4: Vitest Globals**
- **Given:** Writing a test
- **When:** Use describe, it, expect
- **Then:** Available without imports ✅
- **Test Evidence:** All test files use globals without explicit vitest imports

**AC 5: Demo Data Validation**
- **Given:** Need to validate demo data
- **When:** Create test for data loading
- **Then:** Test passes with JSON files ✅
- **Test Evidence:** dataLoader.test.ts validates agents.json structure (id, name, skills)

**AC 6: Coverage Reports**
- **Given:** Need coverage reports
- **When:** Run `npm run test:coverage`
- **Then:** Coverage report with thresholds ✅
- **Test Evidence:** vitest.config.ts configures v8 provider with html/text/lcov reporters and thresholds

### Security Review

**Status: ✅ PASS (N/A for this story)**

No security concerns identified. This story configures testing infrastructure only:
- No authentication, authorization, or data protection components
- No user input handling or validation
- No network requests to external APIs (demo data is local)
- Test files properly excluded from production builds

### Performance Considerations

**Status: ✅ PASS**

Testing framework configuration is performant:
- Vitest is faster than Jest (Vite-native, <50ms HMR per Tech Stack)
- Test execution: 6 tests complete in ~3.3s (reasonable for initial setup)
- Coverage reporting configured with v8 (faster than Istanbul)
- No performance bottlenecks identified

**Future Monitoring:**
- Watch test execution time as test suite grows
- Target: <10s for full test suite, <1s for individual test files

### NFR Assessment

**Maintainability: ✅ PASS**
- Clear configuration files with inline comments
- Well-documented example tests serve as templates
- Consistent test structure (describe/it blocks, beforeEach cleanup)
- Test utilities centralized in src/test/setup.ts

**Reliability: ✅ PASS**
- Proper cleanup after each test (afterEach cleanup)
- Mock restoration before each test (vi.restoreAllMocks)
- Isolated test execution (no shared state between tests)

**Testability: ✅ EXCELLENT**
- This story literally establishes testability infrastructure
- Controllability: Mocking strategy enables input control (global.fetch)
- Observability: React Testing Library queries enable output observation
- Debuggability: Vitest provides clear error messages and stack traces

### Files Modified During Review

**Modified by QA:**
- [vitest.config.ts](../wfm-intelligence-demo/vitest.config.ts) - Corrected component coverage threshold (40% → 50%)

**Note:** Dev Agent should update File List to reflect this QA modification.

### Gate Status

**Gate:** PASS → [docs/qa/gates/1.6-configure-testing-framework.yml](../qa/gates/1.6-configure-testing-framework.yml)

### Recommended Status

**✅ Ready for Done**

The testing framework is properly configured and operational. The single discrepancy (coverage threshold) has been corrected. All acceptance criteria met, all tests passing, excellent foundation for TDD development in Epic 1 and beyond.

**Quality Score:** 95/100
- Minor deduction for initial threshold mismatch (corrected during review)
- Excellent implementation otherwise
